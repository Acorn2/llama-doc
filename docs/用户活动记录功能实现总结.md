# ç”¨æˆ·æ´»åŠ¨è®°å½•åŠŸèƒ½å®ç°æ€»ç»“

## åŠŸèƒ½æ¦‚è¿°

æ ¹æ®å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„"æœ€è¿‘æ´»åŠ¨"éœ€æ±‚ï¼Œæˆ‘å·²ç»æˆåŠŸå®ç°äº†å®Œæ•´çš„ç”¨æˆ·æ´»åŠ¨è®°å½•åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **æ•°æ®åº“è¡¨è®¾è®¡**: åˆ›å»ºäº† `user_activities` è¡¨æ¥å­˜å‚¨ç”¨æˆ·æ´»åŠ¨è®°å½•
2. **æœåŠ¡å±‚å®ç°**: å®ç°äº† `ActivityService` æ¥ç®¡ç†æ´»åŠ¨è®°å½•çš„å¢åˆ æŸ¥æ”¹
3. **å·¥å…·å‡½æ•°**: æä¾›äº†ä¾¿æ·çš„æ´»åŠ¨è®°å½•å·¥å…·å‡½æ•°å’Œè£…é¥°å™¨
4. **APIæ¥å£**: æ·»åŠ äº†æŸ¥è¯¢ç”¨æˆ·æ´»åŠ¨è®°å½•å’Œç»Ÿè®¡çš„APIæ¥å£
5. **è‡ªåŠ¨è®°å½•**: åœ¨å„ä¸ªå…³é”®ä¸šåŠ¡æµç¨‹ä¸­è‡ªåŠ¨è®°å½•ç”¨æˆ·æ´»åŠ¨

## å®ç°çš„æ–‡ä»¶

### 1. æ•°æ®åº“æ¨¡å‹ (`app/database.py`)
- æ–°å¢ `UserActivity` æ•°æ®æ¨¡å‹
- åŒ…å«å®Œæ•´çš„å­—æ®µå®šä¹‰å’Œç´¢å¼•ä¼˜åŒ–
- æ”¯æŒPostgreSQLå’ŒSQLiteæ•°æ®åº“

### 2. æ•°æ®æ¨¡å¼ (`app/schemas.py`)
- `ActivityType` æšä¸¾ï¼šå®šä¹‰æ‰€æœ‰æ”¯æŒçš„æ´»åŠ¨ç±»å‹
- `UserActivityCreate`ï¼šåˆ›å»ºæ´»åŠ¨è®°å½•çš„è¯·æ±‚æ¨¡å‹
- `UserActivityResponse`ï¼šæ´»åŠ¨è®°å½•çš„å“åº”æ¨¡å‹
- `UserActivityListResponse`ï¼šæ´»åŠ¨è®°å½•åˆ—è¡¨å“åº”æ¨¡å‹

### 3. æœåŠ¡å±‚ (`app/services/activity_service.py`)
- `ActivityService` ç±»ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- æ”¯æŒåˆ›å»ºã€æŸ¥è¯¢ã€ç»Ÿè®¡æ´»åŠ¨è®°å½•
- æ”¯æŒæ•°æ®æ¸…ç†å’Œæ€§èƒ½ä¼˜åŒ–

### 4. å·¥å…·å‡½æ•° (`app/utils/activity_logger.py`)
- `log_user_activity`ï¼šä¾¿æ·çš„æ´»åŠ¨è®°å½•å‡½æ•°
- `get_client_info`ï¼šè·å–å®¢æˆ·ç«¯ä¿¡æ¯ï¼ˆIPã€User-Agentï¼‰
- `activity_logger` è£…é¥°å™¨ï¼šè‡ªåŠ¨è®°å½•æ´»åŠ¨çš„è£…é¥°å™¨

### 5. APIæ¥å£æ›´æ–°
æ›´æ–°äº†ä»¥ä¸‹è·¯ç”±æ–‡ä»¶ï¼Œæ·»åŠ äº†ç”¨æˆ·è®¤è¯å’Œæ´»åŠ¨è®°å½•ï¼š

- `app/routers/user_routes.py`ï¼šç”¨æˆ·ç›¸å…³æ“ä½œ
- `app/routers/document_routes.py`ï¼šæ–‡æ¡£ç›¸å…³æ“ä½œ
- `app/routers/knowledge_base_routes.py`ï¼šçŸ¥è¯†åº“ç›¸å…³æ“ä½œ
- `app/routers/agent_router.py`ï¼šAgentç›¸å…³æ“ä½œ
- `app/routers/conversation_routes.py`ï¼šå¯¹è¯ç›¸å…³æ“ä½œ

### 6. è„šæœ¬å’Œæµ‹è¯•
- `scripts/create_user_activities_table.py`ï¼šæ•°æ®åº“è¿ç§»è„šæœ¬
- `scripts/test_user_activities.py`ï¼šå®Œæ•´åŠŸèƒ½æµ‹è¯•è„šæœ¬
- `scripts/simple_test_activities.py`ï¼šç®€åŒ–æµ‹è¯•è„šæœ¬

### 7. æ–‡æ¡£
- `docs/ç”¨æˆ·æ´»åŠ¨è®°å½•åŠŸèƒ½è¯´æ˜.md`ï¼šè¯¦ç»†çš„åŠŸèƒ½è¯´æ˜æ–‡æ¡£
- æ›´æ–°äº† `docs/åç«¯æœåŠ¡å®Œæ•´æ¥å£æ–‡æ¡£-å‰ç«¯å¼€å‘ç‰ˆ.md`

## æ”¯æŒçš„æ´»åŠ¨ç±»å‹

### ç”¨æˆ·è®¤è¯ç›¸å…³
- âœ… `user_login`: ç”¨æˆ·ç™»å½•
- âœ… `user_logout`: ç”¨æˆ·ç™»å‡º  
- âœ… `user_register`: ç”¨æˆ·æ³¨å†Œ

### æ–‡æ¡£ç›¸å…³
- âœ… `document_upload`: æ–‡æ¡£ä¸Šä¼ 
- âœ… `document_delete`: æ–‡æ¡£åˆ é™¤
- âœ… `document_view`: æ–‡æ¡£æŸ¥çœ‹
- âœ… `document_download`: æ–‡æ¡£ä¸‹è½½

### çŸ¥è¯†åº“ç›¸å…³
- âœ… `kb_create`: åˆ›å»ºçŸ¥è¯†åº“
- âœ… `kb_update`: æ›´æ–°çŸ¥è¯†åº“
- âœ… `kb_delete`: åˆ é™¤çŸ¥è¯†åº“
- âœ… `kb_view`: æŸ¥çœ‹çŸ¥è¯†åº“
- âœ… `kb_like`: ç‚¹èµçŸ¥è¯†åº“
- âœ… `kb_unlike`: å–æ¶ˆç‚¹èµ
- âœ… `kb_share`: åˆ†äº«çŸ¥è¯†åº“

### å¯¹è¯ç›¸å…³
- âœ… `conversation_create`: åˆ›å»ºå¯¹è¯
- âœ… `conversation_chat`: è¿›è¡Œå¯¹è¯
- âœ… `conversation_delete`: åˆ é™¤å¯¹è¯

### Agentç›¸å…³
- âœ… `agent_chat`: Agentå¯¹è¯
- âœ… `agent_analyze`: Agentåˆ†æ
- âœ… `agent_search`: Agentæœç´¢
- âœ… `agent_summary`: Agentæ‘˜è¦ç”Ÿæˆ

### ç³»ç»Ÿç›¸å…³
- âœ… `system_access`: ç³»ç»Ÿè®¿é—®

## APIæ¥å£

### 1. è·å–ç”¨æˆ·æ´»åŠ¨è®°å½•
```http
GET /api/v1/users/activities?limit=5&activity_type=document_upload
Authorization: Bearer <token>
```

### 2. è·å–æ´»åŠ¨ç»Ÿè®¡
```http
GET /api/v1/users/activities/stats?days=30
Authorization: Bearer <token>
```

### 3. è·å–ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ® ğŸ†•
```http
GET /api/v1/users/dashboard/stats?period=30d
Authorization: Bearer <token>
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "document_stats": {
      "total": 1234,
      "growth_rate": 0.12,
      "growth_count": 132
    },
    "knowledge_base_stats": {
      "total": 56,
      "growth_rate": 0.08,
      "growth_count": 4
    },
    "conversation_stats": {
      "today": 89,
      "growth_rate": 0.15,
      "yesterday": 77
    },
    "activity_summary": {
      "total_activities": 2456,
      "most_active_type": "agent_chat",
      "recent_activities": [
        {
          "activity_type": "document_upload",
          "count": 12,
          "percentage": 15.2
        }
      ]
    },
    "period": "30d",
    "last_updated": "2024-01-01T12:00:00"
  },
  "message": "è·å–ä»ªè¡¨æ¿ç»Ÿè®¡æˆåŠŸ"
}
```

## æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE user_activities (
    id VARCHAR PRIMARY KEY,
    user_id VARCHAR NOT NULL REFERENCES users(id),
    activity_type VARCHAR NOT NULL,
    activity_description VARCHAR NOT NULL,
    resource_type VARCHAR,
    resource_id VARCHAR,
    activity_metadata TEXT,  -- JSONæ ¼å¼
    ip_address VARCHAR,
    user_agent VARCHAR,
    create_time TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_activity_user_time ON user_activities(user_id, create_time);
CREATE INDEX idx_activity_type_time ON user_activities(activity_type, create_time);
CREATE INDEX idx_activity_resource ON user_activities(resource_type, resource_id);
```

## åŠŸèƒ½ç‰¹ç‚¹

### 1. è‡ªåŠ¨è®°å½•
- æ‰€æœ‰ç”¨æˆ·æ“ä½œéƒ½ä¼šè‡ªåŠ¨è®°å½•ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
- è®°å½•å¤±è´¥ä¸ä¼šå½±å“ä¸»è¦ä¸šåŠ¡æµç¨‹
- æ”¯æŒå¼‚æ­¥è®°å½•ï¼Œä¸å½±å“æ¥å£å“åº”é€Ÿåº¦

### 2. ä¸°å¯Œçš„å…ƒæ•°æ®
æ¯ä¸ªæ´»åŠ¨è®°å½•åŒ…å«ï¼š
- æ´»åŠ¨ç±»å‹å’Œæè¿°
- å…³è”çš„èµ„æºç±»å‹å’ŒID
- æ“ä½œçš„è¯¦ç»†å…ƒæ•°æ®ï¼ˆå¦‚æ–‡ä»¶åã€å¤§å°ç­‰ï¼‰
- ç”¨æˆ·çš„IPåœ°å€å’Œæµè§ˆå™¨ä¿¡æ¯
- ç²¾ç¡®çš„æ—¶é—´æˆ³

### 3. éšç§ä¿æŠ¤
- æ¯ä¸ªç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ´»åŠ¨è®°å½•
- æ•æ„Ÿä¿¡æ¯ä¼šè¢«é€‚å½“å¤„ç†
- æ”¯æŒæ•°æ®æ¸…ç†å’Œè¿‡æœŸåˆ é™¤

### 4. æ€§èƒ½ä¼˜åŒ–
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- æ”¯æŒæŒ‰ç±»å‹å’Œæ—¶é—´è¿‡æ»¤
- å®šæœŸæ•°æ®æ¸…ç†æœºåˆ¶

## æµ‹è¯•ç»“æœ

âœ… æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ  
âœ… åŸºæœ¬CRUDæ“ä½œæ­£å¸¸  
âœ… ç´¢å¼•å’ŒæŸ¥è¯¢æ€§èƒ½è‰¯å¥½  
âœ… JSONå…ƒæ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£å¸¸  
âœ… æ—¶é—´æ’åºå’Œåˆ†é¡µåŠŸèƒ½æ­£å¸¸  

## å‰ç«¯é›†æˆå»ºè®®

### 1. è·å–æœ€è¿‘æ´»åŠ¨
```javascript
const getRecentActivities = async () => {
  const response = await fetch('/api/v1/users/activities?limit=5', {
    headers: getAuthHeaders()
  });
  return await response.json();
};
```

### 2. å±•ç¤ºæ´»åŠ¨åˆ—è¡¨
```javascript
const activityTypeMap = {
  'user_login': 'ç”¨æˆ·ç™»å½•',
  'document_upload': 'ä¸Šä¼ æ–‡æ¡£',
  'kb_create': 'åˆ›å»ºçŸ¥è¯†åº“',
  'agent_chat': 'AIå¯¹è¯'
};

const renderActivity = (activity) => `
  <div class="activity-item">
    <div class="activity-icon">${getActivityIcon(activity.activity_type)}</div>
    <div class="activity-content">
      <div class="activity-description">${activity.activity_description}</div>
      <div class="activity-time">${formatTime(activity.create_time)}</div>
    </div>
  </div>
`;
```

### 3. æ´»åŠ¨ç»Ÿè®¡å›¾è¡¨
```javascript
const getActivityStats = async () => {
  const response = await fetch('/api/v1/users/activities/stats?days=30', {
    headers: getAuthHeaders()
  });
  const result = await response.json();
  return result.data;
};
```

### 4. ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ® ğŸ†•
```javascript
// è·å–ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ®
const getDashboardStats = async (period = '30d') => {
  const response = await fetch(`/api/v1/users/dashboard/stats?period=${period}`, {
    headers: getAuthHeaders()
  });
  const result = await response.json();
  return result.data;
};

// ä½¿ç”¨ç¤ºä¾‹
const stats = await getDashboardStats('30d');

// æ˜¾ç¤ºæ–‡æ¡£ç»Ÿè®¡
console.log('æ–‡æ¡£æ€»æ•°:', stats.document_stats.total);
console.log('æ–‡æ¡£å¢é•¿ç‡:', (stats.document_stats.growth_rate * 100).toFixed(1) + '%');

// æ˜¾ç¤ºçŸ¥è¯†åº“ç»Ÿè®¡
console.log('çŸ¥è¯†åº“æ•°é‡:', stats.knowledge_base_stats.total);
console.log('çŸ¥è¯†åº“å¢é•¿ç‡:', (stats.knowledge_base_stats.growth_rate * 100).toFixed(1) + '%');

// æ˜¾ç¤ºä»Šæ—¥å¯¹è¯
console.log('ä»Šæ—¥å¯¹è¯:', stats.conversation_stats.today);
console.log('å¯¹è¯å¢é•¿ç‡:', (stats.conversation_stats.growth_rate * 100).toFixed(1) + '%');

// æ¸²æŸ“ä»ªè¡¨æ¿å¡ç‰‡
const renderDashboardCard = (title, value, growthRate, icon) => `
  <div class="dashboard-card">
    <div class="card-icon">${icon}</div>
    <div class="card-content">
      <h3>${title}</h3>
      <div class="card-value">${value.toLocaleString()}</div>
      <div class="card-growth ${growthRate >= 0 ? 'positive' : 'negative'}">
        ${growthRate >= 0 ? '+' : ''}${(growthRate * 100).toFixed(1)}%
      </div>
    </div>
  </div>
`;

// æ¸²æŸ“ä»ªè¡¨æ¿
const renderDashboard = (stats) => {
  const dashboard = document.getElementById('dashboard');
  dashboard.innerHTML = `
    ${renderDashboardCard('æ–‡æ¡£æ€»æ•°', stats.document_stats.total, stats.document_stats.growth_rate, 'ğŸ“„')}
    ${renderDashboardCard('çŸ¥è¯†åº“æ•°é‡', stats.knowledge_base_stats.total, stats.knowledge_base_stats.growth_rate, 'ğŸ“š')}
    ${renderDashboardCard('ä»Šæ—¥å¯¹è¯', stats.conversation_stats.today, stats.conversation_stats.growth_rate, 'ğŸ’¬')}
  `;
};
```

## éƒ¨ç½²è¯´æ˜

1. **è¿è¡Œæ•°æ®åº“è¿ç§»**ï¼š
   ```bash
   python scripts/create_user_activities_table.py
   ```

2. **éªŒè¯åŠŸèƒ½**ï¼š
   ```bash
   python scripts/simple_test_activities.py
   ```

3. **å¯åŠ¨æœåŠ¡**ï¼š
   ```bash
   python -m uvicorn app.main:app --reload
   ```

## ç»´æŠ¤å»ºè®®

1. **å®šæœŸæ¸…ç†æ•°æ®**ï¼šå»ºè®®æ¯æœˆæ¸…ç†90å¤©å‰çš„æ´»åŠ¨è®°å½•
2. **ç›‘æ§æ€§èƒ½**ï¼šå…³æ³¨æ´»åŠ¨è®°å½•çš„å†™å…¥é¢‘ç‡å’ŒæŸ¥è¯¢æ€§èƒ½
3. **å¤‡ä»½é‡è¦æ•°æ®**ï¼šå¯¹äºé‡è¦çš„æ´»åŠ¨è®°å½•è¿›è¡Œå®šæœŸå¤‡ä»½
4. **æ‰©å±•åŠŸèƒ½**ï¼šå¯ä»¥åŸºäºæ´»åŠ¨è®°å½•å®ç°æ›´å¤šåˆ†æåŠŸèƒ½

## æ€»ç»“

ç”¨æˆ·æ´»åŠ¨è®°å½•åŠŸèƒ½å·²ç»å®Œå…¨å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å®Œæ•´çš„æ•°æ®åº“è®¾è®¡å’Œæ¨¡å‹
- âœ… å…¨é¢çš„æœåŠ¡å±‚å®ç°
- âœ… ä¾¿æ·çš„å·¥å…·å‡½æ•°å’Œè£…é¥°å™¨
- âœ… å®Œæ•´çš„APIæ¥å£
- âœ… è‡ªåŠ¨è®°å½•æœºåˆ¶
- âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œæµ‹è¯•

è¯¥åŠŸèƒ½å¯ä»¥æ»¡è¶³å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„"æœ€è¿‘æ´»åŠ¨"éœ€æ±‚ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±æœ€è¿‘çš„5æ¡æ´»åŠ¨è®°å½•ï¼ŒåŒ…æ‹¬ä¸Šä¼ æ–‡æ¡£ã€è¿›è¡Œå¯¹è¯ã€ç”Ÿæˆæ‘˜è¦ç­‰å„ç§æ“ä½œã€‚åŒæ—¶è¿˜æä¾›äº†ä¸°å¯Œçš„ç»Ÿè®¡åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£è‡ªå·±çš„ä½¿ç”¨ä¹ æƒ¯ã€‚

## ğŸ†• æ–°å¢ä»ªè¡¨æ¿ç»Ÿè®¡æ¥å£

æ ¹æ®å‰ç«¯ä»ªè¡¨æ¿éœ€æ±‚ï¼Œæ–°å¢äº† `/api/v1/users/dashboard/stats` æ¥å£ï¼Œæ”¯æŒï¼š

### åŠŸèƒ½ç‰¹ç‚¹
- **æ–‡æ¡£ç»Ÿè®¡**: æ˜¾ç¤ºæ–‡æ¡£æ€»æ•°åŠå¢é•¿ç‡
- **çŸ¥è¯†åº“ç»Ÿè®¡**: æ˜¾ç¤ºçŸ¥è¯†åº“æ•°é‡åŠå¢é•¿ç‡  
- **å¯¹è¯ç»Ÿè®¡**: æ˜¾ç¤ºä»Šæ—¥å¯¹è¯æ•°åŠå¢é•¿ç‡
- **æ´»åŠ¨æ‘˜è¦**: æä¾›æ´»åŠ¨ç±»å‹åˆ†å¸ƒå’Œæœ€æ´»è·ƒç±»å‹
- **å¤šå‘¨æœŸæ”¯æŒ**: æ”¯æŒ7å¤©ã€30å¤©ã€90å¤©ç»Ÿè®¡å‘¨æœŸ
- **å¢é•¿ç‡è®¡ç®—**: è‡ªåŠ¨è®¡ç®—ç›¸æ¯”ä¸Šä¸€å‘¨æœŸçš„å¢é•¿ç‡

### æ•°æ®ç»“æ„
```json
{
  "document_stats": {
    "total": 1234,        // æ–‡æ¡£æ€»æ•°
    "growth_rate": 0.12,  // å¢é•¿ç‡ (12%)
    "growth_count": 132   // å¢é•¿æ•°é‡
  },
  "knowledge_base_stats": {
    "total": 56,
    "growth_rate": 0.08,
    "growth_count": 4
  },
  "conversation_stats": {
    "today": 89,          // ä»Šæ—¥å¯¹è¯æ•°
    "growth_rate": 0.15,  // ç›¸æ¯”æ˜¨æ—¥å¢é•¿ç‡
    "yesterday": 77       // æ˜¨æ—¥å¯¹è¯æ•°
  }
}
```

### å®ç°æ–‡ä»¶
- `app/schemas/__init__.py`: æ–°å¢ä»ªè¡¨æ¿ç»Ÿè®¡ç›¸å…³æ•°æ®æ¨¡å‹
- `app/services/activity_service.py`: æ–°å¢ `get_dashboard_stats` æ–¹æ³•
- `app/routers/user_routes.py`: æ–°å¢ `/dashboard/stats` è·¯ç”±
- `scripts/test_dashboard_stats.py`: æµ‹è¯•è„šæœ¬