# 用户活动记录功能说明

## 概述

用户活动记录功能是一个全面的用户行为跟踪系统，能够自动记录用户在系统中的各种操作行为，为用户提供活动历史查看和统计分析功能。

## 功能特点

### 1. 自动记录
- 所有用户操作都会自动记录，无需手动调用
- 记录失败不会影响主要业务流程
- 支持异步记录，不影响接口响应速度

### 2. 丰富的活动类型
支持记录以下类型的用户活动：

#### 用户认证相关
- 用户注册、登录、登出

#### 文档管理相关
- 文档上传、删除、查看、下载

#### 知识库管理相关
- 知识库创建、更新、删除、查看
- 知识库点赞、取消点赞、分享

#### 对话相关
- 对话创建、聊天、删除

#### Agent相关
- Agent对话、文档分析、知识搜索、摘要生成

### 3. 详细的元数据记录
每个活动记录包含：
- 活动类型和描述
- 关联的资源类型和ID
- 操作的详细元数据（如文件名、大小等）
- 用户的IP地址和浏览器信息
- 精确的时间戳

### 4. 隐私保护
- 每个用户只能查看自己的活动记录
- 敏感信息会被适当处理
- 支持数据清理和过期删除

## API接口

### 获取用户活动记录
```http
GET /api/v1/users/activities?limit=5&activity_type=document_upload
Authorization: Bearer <token>
```

**参数说明：**
- `limit`: 返回记录数量（默认5，最大20）
- `activity_type`: 按活动类型过滤（可选）

### 获取活动统计
```http
GET /api/v1/users/activities/stats?days=30
Authorization: Bearer <token>
```

**参数说明：**
- `days`: 统计天数（默认30天）

## 使用示例

### 前端获取用户最近活动
```javascript
// 获取用户最近5条活动记录
const getRecentActivities = async () => {
  const response = await fetch('/api/v1/users/activities?limit=5', {
    headers: getAuthHeaders()
  });
  const activities = await response.json();
  
  return activities.map(activity => ({
    id: activity.id,
    type: activity.activity_type,
    description: activity.activity_description,
    time: new Date(activity.create_time),
    metadata: activity.activity_metadata
  }));
};

// 获取用户活动统计
const getActivityStats = async (days = 30) => {
  const response = await fetch(`/api/v1/users/activities/stats?days=${days}`, {
    headers: getAuthHeaders()
  });
  const result = await response.json();
  
  return result.data;
};
```

### 前端展示活动记录
```javascript
// 活动类型的中文映射
const activityTypeMap = {
  'user_login': '用户登录',
  'document_upload': '上传文档',
  'kb_create': '创建知识库',
  'agent_chat': 'AI对话',
  'conversation_create': '创建对话'
};

// 渲染活动列表
const renderActivities = (activities) => {
  return activities.map(activity => `
    <div class="activity-item">
      <div class="activity-type">${activityTypeMap[activity.type] || activity.type}</div>
      <div class="activity-description">${activity.description}</div>
      <div class="activity-time">${formatTime(activity.time)}</div>
    </div>
  `).join('');
};
```

## 数据库设计

### 用户活动记录表 (user_activities)
```sql
CREATE TABLE user_activities (
    id VARCHAR PRIMARY KEY,
    user_id VARCHAR NOT NULL REFERENCES users(id),
    activity_type VARCHAR NOT NULL,
    activity_description VARCHAR NOT NULL,
    resource_type VARCHAR,
    resource_id VARCHAR,
    activity_metadata TEXT,  -- JSON格式
    ip_address VARCHAR,
    user_agent VARCHAR,
    create_time TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_activity_user_time ON user_activities(user_id, create_time);
CREATE INDEX idx_activity_type_time ON user_activities(activity_type, create_time);
CREATE INDEX idx_activity_resource ON user_activities(resource_type, resource_id);
```

## 开发指南

### 在新接口中添加活动记录

1. **导入必要的模块**
```python
from app.utils.activity_logger import log_user_activity
from app.schemas import ActivityType
```

2. **在接口中记录活动**
```python
@router.post("/some-action")
async def some_action(
    request: Request,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 执行主要业务逻辑
    result = do_something()
    
    # 记录用户活动
    log_user_activity(
        db=db,
        user=current_user,
        activity_type=ActivityType.SOME_ACTION,
        description="执行某个操作",
        request=request,
        resource_type="resource_type",
        resource_id="resource_id",
        metadata={"key": "value"}
    )
    
    return result
```

### 添加新的活动类型

1. **在schemas.py中添加新的活动类型**
```python
class ActivityType(str, Enum):
    # 现有类型...
    NEW_ACTION = "new_action"
```

2. **更新文档中的活动类型说明**

### 性能考虑

1. **异步记录**: 活动记录不应阻塞主要业务流程
2. **批量处理**: 对于高频操作，考虑批量记录
3. **数据清理**: 定期清理过期的活动记录
4. **索引优化**: 确保查询性能

## 维护和监控

### 数据清理
```python
# 清理90天前的活动记录
from app.services.activity_service import activity_service

deleted_count = activity_service.delete_old_activities(db, days=90)
print(f"清理了 {deleted_count} 条过期记录")
```

### 监控指标
- 活动记录的写入频率
- 查询响应时间
- 存储空间使用情况
- 错误率统计

## 注意事项

1. **隐私保护**: 不要记录敏感信息（如密码、token等）
2. **性能影响**: 活动记录失败不应影响主要功能
3. **存储管理**: 定期清理过期数据，避免数据库膨胀
4. **权限控制**: 确保用户只能访问自己的活动记录
5. **错误处理**: 活动记录异常应该被捕获和记录，但不抛出

## 扩展功能

### 未来可能的扩展
1. **实时通知**: 基于活动记录的实时通知系统
2. **行为分析**: 用户行为模式分析和推荐
3. **审计日志**: 管理员查看系统整体活动情况
4. **数据导出**: 用户活动数据的导出功能
5. **可视化**: 活动记录的图表展示