# æµå¼æ‰“å­—æœºæ•ˆæœä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨æµå¼æ‰“å­—æœºæ•ˆæœå·¥å…·ç±»ï¼Œä¸ºå¯¹è¯å’ŒAgentæ¥å£å®ç°ç±»ä¼¼æ‰“å­—æœºçš„è¾“å‡ºæ•ˆæœï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

## æ ¸å¿ƒç»„ä»¶

### 1. TypewriterStreamer ç±»

æ ¸å¿ƒçš„æ‰“å­—æœºæ•ˆæœå®ç°ç±»ï¼Œæ”¯æŒå¤šç§é…ç½®é€‰é¡¹ï¼š

```python
from app.utils.streaming_utils import TypewriterStreamer

typewriter = TypewriterStreamer(
    chunk_size=1,           # æ¯æ¬¡è¾“å‡ºçš„å­—ç¬¦æ•°
    delay=0.05,             # æ¯ä¸ªå­—ç¬¦é—´çš„å»¶è¿Ÿï¼ˆç§’ï¼‰
    sentence_delay=0.2,     # å¥å­ç»“æŸåçš„å»¶è¿Ÿ
    paragraph_delay=0.5,    # æ®µè½ç»“æŸåçš„å»¶è¿Ÿ
    word_delay=0.1,         # å•è¯ç»“æŸåçš„å»¶è¿Ÿ
    enable_smart_delay=True # æ˜¯å¦å¯ç”¨æ™ºèƒ½å»¶è¿Ÿ
)
```

### 2. StreamingResponseBuilder ç±»

ç”¨äºæ„å»ºä¸åŒç±»å‹çš„æµå¼å“åº”ï¼š

```python
from app.utils.streaming_utils import StreamingResponseBuilder, StreamingPresets

# åˆ›å»ºå¯¹è¯æµå¼å“åº”
stream_generator = StreamingResponseBuilder.create_conversation_stream(
    response_text="æ‚¨çš„å›å¤å†…å®¹",
    conversation_id="conv-123",
    sources=[{"content": "æ¥æº1", "score": 0.95}],
    processing_time=1.23,
    typewriter_config=StreamingPresets.STANDARD
)

# åˆ›å»ºAgentæµå¼å“åº”
stream_generator = StreamingResponseBuilder.create_agent_stream(
    response_data={"answer": "Agentå›å¤", "agent_mode": "analysis"},
    kb_id="kb-456",
    use_agent=True,
    typewriter_config=StreamingPresets.FAST
)
```

### 3. é¢„è®¾é…ç½®

æä¾›äº†å¤šç§é¢„è®¾é…ç½®ä»¥é€‚åº”ä¸åŒåœºæ™¯ï¼š

```python
from app.utils.streaming_utils import StreamingPresets

# å¿«é€Ÿæ¨¡å¼ - é€‚åˆæ¼”ç¤º
StreamingPresets.FAST

# æ ‡å‡†æ¨¡å¼ - å¹³è¡¡ä½“éªŒ
StreamingPresets.STANDARD

# æ…¢é€Ÿæ¨¡å¼ - æ›´çœŸå®çš„æ‰“å­—æ•ˆæœ
StreamingPresets.SLOW

# æ— å»¶è¿Ÿæ¨¡å¼ - å¿«é€Ÿè¾“å‡º
StreamingPresets.NO_DELAY
```

## APIæ¥å£é›†æˆ

### 1. Agentæµå¼æ¥å£

åœ¨ `app/routers/agent_router.py` ä¸­çš„ `/api/v1/agent/chat/stream` æ¥å£ï¼š

```python
@router.post("/chat/stream")
async def agent_chat_stream(
    request: AgentChatRequest,
    current_user: User = Depends(get_current_user),
    agent_service: AgentService = Depends(get_agent_service_dep),
    db: Session = Depends(get_db)
):
    from app.utils.streaming_utils import StreamingResponseBuilder, StreamingPresets
    
    async def generate_stream():
        # è·å–Agentå“åº”
        result = await agent_service.chat_with_agent(...)
        
        # é€‰æ‹©åˆé€‚çš„é¢„è®¾
        response_length = len(result["data"]["answer"])
        if response_length < 100:
            preset = StreamingPresets.FAST
        elif response_length < 500:
            preset = StreamingPresets.STANDARD
        else:
            preset = StreamingPresets.SLOW
        
        # åˆ›å»ºæµå¼å“åº”
        stream_generator = StreamingResponseBuilder.create_agent_stream(
            response_data=result["data"],
            kb_id=request.kb_id,
            use_agent=request.use_agent,
            typewriter_config=preset
        )
        
        async for chunk in stream_generator:
            yield chunk
    
    return StreamingResponse(generate_stream(), ...)
```

### 2. å¯¹è¯æµå¼æ¥å£

åœ¨ `app/routers/conversation_routes.py` ä¸­çš„ `/api/v1/conversations/chat/stream` æ¥å£ï¼š

```python
@router.post("/chat/stream")
async def chat_stream(
    request: ChatRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    from app.utils.streaming_utils import StreamingResponseBuilder, StreamingPresets
    
    async def generate_stream():
        # ç”Ÿæˆå›å¤
        if use_agent:
            # Agentæ¨¡å¼
            response = adapter.generate_agent_response(...)
            stream_generator = StreamingResponseBuilder.create_conversation_stream(
                response_text=response["answer"],
                conversation_id=conversation_id,
                sources=response.get("sources", []),
                typewriter_config=StreamingPresets.STANDARD
            )
        else:
            # æ™®é€šå¯¹è¯æ¨¡å¼
            result = conversation_manager.generate_response(...)
            # å¤„ç†æµå¼æ•°æ®...
        
        async for chunk in stream_generator:
            yield chunk
    
    return StreamingResponse(generate_stream(), ...)
```

## æ•°æ®æ ¼å¼

### SSEæ•°æ®æ ¼å¼

æ‰€æœ‰æµå¼æ•°æ®éƒ½ä»¥Server-Sent Events (SSE)æ ¼å¼è¿”å›ï¼š

```
data: {"type": "content", "content": "ä½ ", "is_final": false, "timestamp": 1234567890.123}

data: {"type": "content", "content": "å¥½", "is_final": false, "timestamp": 1234567890.173}

data: {"type": "final", "content": "", "is_final": true, "metadata": {...}, "timestamp": 1234567890.456}
```

### æ•°æ®å—ç±»å‹

- `content`: å†…å®¹å—ï¼ŒåŒ…å«è¦æ˜¾ç¤ºçš„æ–‡æœ¬
- `metadata`: å…ƒæ•°æ®å—ï¼ŒåŒ…å«é™„åŠ ä¿¡æ¯
- `error`: é”™è¯¯å—ï¼ŒåŒ…å«é”™è¯¯ä¿¡æ¯
- `final`: æœ€ç»ˆå—ï¼Œæ ‡è¯†æµå¼è¾“å‡ºç»“æŸ
- `heartbeat`: å¿ƒè·³å—ï¼Œç”¨äºä¿æŒè¿æ¥

## å‰ç«¯é›†æˆ

### JavaScriptç¤ºä¾‹

```javascript
async function streamResponse(message, jwtToken) {
    const response = await fetch('/api/v1/agent/chat/stream', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
        },
        body: JSON.stringify({
            kb_id: 'your-kb-id',
            message: message,
            use_agent: true
        })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let assistantMessage = '';

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
            if (line.startsWith('data: ')) {
                const data = JSON.parse(line.slice(6));
                
                if (data.type === 'content') {
                    assistantMessage += data.content;
                    updateUI(assistantMessage + '|'); // æ˜¾ç¤ºå…‰æ ‡
                } else if (data.type === 'final') {
                    updateUI(assistantMessage); // ç§»é™¤å…‰æ ‡
                    console.log('å®Œæˆ:', data.metadata);
                }
            }
        }
    }
}
```

### Reactç¤ºä¾‹

```jsx
import { useState, useEffect } from 'react';

function StreamingChat() {
    const [messages, setMessages] = useState([]);
    const [currentMessage, setCurrentMessage] = useState('');
    const [isStreaming, setIsStreaming] = useState(false);

    const sendMessage = async (text) => {
        setIsStreaming(true);
        setCurrentMessage('');
        
        const response = await fetch('/api/v1/conversations/chat/stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                kb_id: kbId,
                message: text
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullMessage = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = JSON.parse(line.slice(6));
                    
                    if (data.type === 'content') {
                        fullMessage += data.content;
                        setCurrentMessage(fullMessage);
                    } else if (data.type === 'final') {
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: fullMessage
                        }]);
                        setCurrentMessage('');
                        setIsStreaming(false);
                    }
                }
            }
        }
    };

    return (
        <div>
            {messages.map((msg, idx) => (
                <div key={idx} className={msg.role}>
                    {msg.content}
                </div>
            ))}
            {isStreaming && (
                <div className="assistant">
                    {currentMessage}<span className="cursor">|</span>
                </div>
            )}
        </div>
    );
}
```

## é…ç½®å»ºè®®

### æ ¹æ®åœºæ™¯é€‰æ‹©é¢„è®¾

1. **æ¼”ç¤ºåœºæ™¯**: ä½¿ç”¨ `StreamingPresets.FAST`
   - å¿«é€Ÿå±•ç¤ºæ•ˆæœ
   - é€‚åˆäº§å“æ¼”ç¤º

2. **æ­£å¸¸ä½¿ç”¨**: ä½¿ç”¨ `StreamingPresets.STANDARD`
   - å¹³è¡¡çš„ç”¨æˆ·ä½“éªŒ
   - é€‚åˆæ—¥å¸¸å¯¹è¯

3. **æ²‰æµ¸ä½“éªŒ**: ä½¿ç”¨ `StreamingPresets.SLOW`
   - æ›´çœŸå®çš„æ‰“å­—æ„Ÿè§‰
   - é€‚åˆé•¿æ–‡æœ¬é˜…è¯»

4. **æ€§èƒ½ä¼˜å…ˆ**: ä½¿ç”¨ `StreamingPresets.NO_DELAY`
   - å¿«é€Ÿè¾“å‡ºæ‰€æœ‰å†…å®¹
   - é€‚åˆç½‘ç»œè¾ƒå·®çš„ç¯å¢ƒ

### è‡ªå®šä¹‰é…ç½®

```python
custom_config = {
    "chunk_size": 2,        # æ¯æ¬¡è¾“å‡º2ä¸ªå­—ç¬¦
    "delay": 0.03,          # 30mså»¶è¿Ÿ
    "sentence_delay": 0.15, # å¥å­å»¶è¿Ÿ150ms
    "paragraph_delay": 0.3, # æ®µè½å»¶è¿Ÿ300ms
    "word_delay": 0.08,     # å•è¯å»¶è¿Ÿ80ms
    "enable_smart_delay": True
}

typewriter = TypewriterStreamer(**custom_config)
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æ™ºèƒ½å»¶è¿Ÿ

å¯ç”¨ `enable_smart_delay` å¯ä»¥æ ¹æ®æ–‡æœ¬å†…å®¹æ™ºèƒ½è°ƒæ•´å»¶è¿Ÿï¼š
- å¥å­ç»“æŸç¬¦åå»¶è¿Ÿæ›´é•¿
- æ®µè½ç»“æŸåå»¶è¿Ÿæœ€é•¿
- å•è¯åˆ†éš”ç¬¦åé€‚ä¸­å»¶è¿Ÿ

### 2. å—å¤§å°ä¼˜åŒ–

- çŸ­æ–‡æœ¬: `chunk_size=1` (é€å­—ç¬¦)
- ä¸­ç­‰æ–‡æœ¬: `chunk_size=2-3` (å¹³è¡¡æ•ˆæœå’Œæ€§èƒ½)
- é•¿æ–‡æœ¬: `chunk_size=5-10` (æé«˜æ€§èƒ½)

### 3. ç½‘ç»œä¼˜åŒ–

- ä½¿ç”¨é€‚å½“çš„ç¼“å†²åŒºå¤§å°
- è€ƒè™‘ç½‘ç»œå»¶è¿Ÿè°ƒæ•´æœ¬åœ°å»¶è¿Ÿ
- å®ç°æ–­çº¿é‡è¿æœºåˆ¶

## æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬æŸ¥çœ‹æ•ˆæœï¼š

```bash
python test_streaming_typewriter.py
```

æ‰“å¼€HTMLæ¼”ç¤ºé¡µé¢ï¼š

```bash
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
open frontend_streaming_example.html
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æµå¼è¾“å‡ºä¸­æ–­**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯JWT Tokenæœ‰æ•ˆæ€§
   - ç¡®è®¤æœåŠ¡å™¨æ”¯æŒSSE

2. **æ‰“å­—æ•ˆæœä¸æµç•…**
   - è°ƒæ•´å»¶è¿Ÿå‚æ•°
   - æ£€æŸ¥å‰ç«¯æ¸²æŸ“æ€§èƒ½
   - è€ƒè™‘ä½¿ç”¨æ›´å°çš„chunk_size

3. **å†…å®¹æ˜¾ç¤ºä¸å®Œæ•´**
   - æ£€æŸ¥SSEæ•°æ®è§£æ
   - éªŒè¯ç¼–ç æ ¼å¼
   - ç¡®è®¤finalå—å¤„ç†

### è°ƒè¯•æŠ€å·§

1. å¯ç”¨è¯¦ç»†æ—¥å¿—
2. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ç›‘æ§ç½‘ç»œ
3. æ£€æŸ¥SSEæ•°æ®æ ¼å¼
4. éªŒè¯JSONè§£æ

## æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ éŸ³æ•ˆ

```javascript
function playTypingSound() {
    const audio = new Audio('/sounds/typing.mp3');
    audio.volume = 0.1;
    audio.play().catch(() => {}); // å¿½ç•¥è‡ªåŠ¨æ’­æ”¾é™åˆ¶é”™è¯¯
}
```

### 2. è‡ªå®šä¹‰å…‰æ ‡æ ·å¼

```css
.cursor {
    animation: blink 1s infinite;
    color: #007bff;
    font-weight: bold;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}
```

### 3. å“åº”å¼å»¶è¿Ÿ

æ ¹æ®ç”¨æˆ·è®¾å¤‡æ€§èƒ½åŠ¨æ€è°ƒæ•´å»¶è¿Ÿï¼š

```javascript
function getOptimalDelay() {
    const connection = navigator.connection;
    if (connection) {
        if (connection.effectiveType === 'slow-2g') return 0.1;
        if (connection.effectiveType === '2g') return 0.08;
        if (connection.effectiveType === '3g') return 0.05;
        return 0.03; // 4gæˆ–æ›´å¿«
    }
    return 0.05; // é»˜è®¤å€¼
}
```

## æ€»ç»“

æµå¼æ‰“å­—æœºæ•ˆæœå·¥å…·ç±»æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

- ğŸ¯ å¤šç§é¢„è®¾é…ç½®é€‚åº”ä¸åŒåœºæ™¯
- âš¡ é«˜æ€§èƒ½çš„å¼‚æ­¥æµå¼å¤„ç†
- ğŸ¨ çµæ´»çš„è‡ªå®šä¹‰é€‰é¡¹
- ğŸ“± å®Œæ•´çš„å‰ç«¯é›†æˆç¤ºä¾‹
- ğŸ”§ è¯¦ç»†çš„é…ç½®å’Œè°ƒè¯•æŒ‡å—

é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œå¯ä»¥ä¸ºç”¨æˆ·æä¾›æ›´åŠ ç”ŸåŠ¨å’Œå¸å¼•äººçš„å¯¹è¯ä½“éªŒã€‚