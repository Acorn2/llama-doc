# 流式对话接口对接指南 - 最新版

本文档旨在为前端开发人员提供最新的流式对话接口（SSE）对接指南。通过本次优化，系统已实现全链路“真流式”输出，消除了 Agent 模式下的响应延迟，提供了极佳的用户交互体验。

## 1. 接口概述

该接口采用 **Server-Sent Events (SSE)** 协议，实现类似 ChatGPT 的实时打字机效果。

- **接口地址**: `POST /api/v1/conversations/chat/stream`
- **请求频率**: 建议根据用户输入触发，支持连续对话。
- **协议说明**: 响应头包含 `Content-Type: text/event-stream`。

## 2. 请求参数

### 请求体 (JSON)

| 参数名 | 类型 | 必选 | 说明 |
| :--- | :--- | :--- | :--- |
| `kb_id` | `string` | 是 | 知识库 ID |
| `message` | `string` | 是 | 用户提问的消息内容 |
| `conversation_id` | `string` | 否 | 对话 ID。如果为空，系统将自动创建新对话并返回 ID |
| `use_agent` | `boolean` | 否 | 是否启用 Agent 模式（默认 `false`） |

### 示例请求

```json
{
  "kb_id": "83b9222f-90d6-4b7a-b977-2fde9d059bae",
  "message": "请总结文档的核心观点",
  "use_agent": true
}
```

## 3. 响应格式 (SSE)

后端会流式推送多个 `data` 块，每个块是一个 JSON 字符串。

### 消息结构

```json
{
  "type": "content | metadata | final | error",
  "content": "消息文本片段",
  "metadata": {
    "conversation_id": "...",
    "sources": [],
    "processing_time": 1.2
  },
  "is_final": false,
  "timestamp": 1704153600.0
}
```

### 数据块类型说明 (`type`)

1.  **`metadata`**: 传输开始时的元数据（如 `conversation_id`）。
2.  **`content`**: 实时生成的文本片段。前端应将其追加到已显示的内容后面。
3.  **`final`**: 传输结束标记。包含完整的引用来源（`sources`）和总处理时间。
4.  **`error`**: 发生异常时的错误提示。

## 4. 前端对接建议 (Vue/JS)

由于是 `POST` 请求且需要处理流，建议使用 `fetch` 结合 `ReadableStream` 或相关库。

### 核心代码片段

```javascript
const response = await fetch('/api/v1/conversations/chat/stream', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    kb_id: '...',
    message: '...',
    use_agent: true
  })
});

const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;

  const chunk = decoder.decode(value);
  const lines = chunk.split('\n');
  
  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = JSON.parse(line.substring(6));
      
      if (data.type === 'content') {
        // 追加到聊天气泡
        chatMessage.content += data.content;
      } else if (data.type === 'final') {
        // 更新引用来源等
        chatMessage.sources = data.metadata.sources;
      }
    }
  }
}
```

## 5. 模式差异

| 模式 | 实时性 | 智能程度 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **普通模式** | 极高 (真流式) | 基础 RAG | 快速问答，简单内容提取。 |
| **Agent 模式** | **极高 (真流式)** | 高 (多工具调用) | 需要深度分析、联网搜索或复杂逻辑推理。 |

> **注意**：经过最新优化，Agent 模式现在也支持“边思考边输出”，不再有明显的首字等待延迟。

## 6. 注意事项

*   **超时处理**: SSE 连接可能因负载均衡配置而意外断开，前端应有重连或报错提示逻辑。
*   **缓存控制**: 接口已默认设置 `Cache-Control: no-cache`。
*   **打字机平滑度**: 后端已内置打字机算法进行平滑处理，前端直接展示即可获得自然效果。
